<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://4l0n3r.github.io/ name=base><title>
            
                First Flight 3 : Thunder Loan
            
        </title><meta content="First Flight 3 : Thunder Loan" property=og:title><meta content="Aka S0m30n3" property=og:description><meta content="Aka S0m30n3" name=description><link href=/favicons/favicon.ico rel=icon type=image/png><link href=https://4l0n3r.github.io/fonts.css rel=stylesheet><script src=https://4l0n3r.github.io/js/codeblock.js></script><script src=https://4l0n3r.github.io/js/toc.js></script><script src=https://4l0n3r.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://4l0n3r.github.io/atom.xml rel=alternate title=Johny type=application/atom+xml><link href=https://4l0n3r.github.io/theme/light.css rel=stylesheet><link href=https://4l0n3r.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://4l0n3r.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://4l0n3r.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://4l0n3r.github.io/>Johny</a><div class=socials><a class=social href=https://x.com/0xJ0hny rel=me> <img alt=twitter src=https://4l0n3r.github.io/icons/social/twitter.svg> </a><a class=social href=https://github.com/4l0n3r/ rel=me> <img alt=github src=https://4l0n3r.github.io/icons/social/github.svg> </a><a class=social href=https://www.linkedin.com/in/johny-vasamsettti/ rel=me> <img alt=linkedin src=https://4l0n3r.github.io/icons/social/linkedin.svg> </a><a href="mailto: vasamsetti.johny@gmail.com" class=social rel=me> <img alt=Email src=https://4l0n3r.github.io/icons/social/email.svg> </a></div></div><nav><a href=https://4l0n3r.github.io/posts style=margin-left:.25em>/posts</a><a href=https://4l0n3r.github.io/writeups style=margin-left:.25em>/writeups</a><a href=https://4l0n3r.github.io/projects style=margin-left:.25em>/projects</a><a href=https://4l0n3r.github.io/tags style=margin-left:.25em>/tags</a><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://4l0n3r.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://4l0n3r.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>First Flight 3 : Thunder Loan<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2023-10-25</time> :: 582 Words</div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://4l0n3r.github.io/writeups/first-flight-3-thunder-loan/#high>High</a> <ul><li><a href=https://4l0n3r.github.io/writeups/first-flight-3-thunder-loan/#h-1-storage-collision-due-to-variable-order-mismatch>[H-1] Storage Collision Due to Variable Order Mismatch</a><li><a href=https://4l0n3r.github.io/writeups/first-flight-3-thunder-loan/#h-2-incorrect-updateexchangerate-call-in-deposit-function>[H-2] Incorrect updateExchangeRate Call in deposit Function</a><li><a href=https://4l0n3r.github.io/writeups/first-flight-3-thunder-loan/#h-3-flashloan-and-deposit-exploit-allows-fund-theft>[H-3] Flashloan and Deposit Exploit Allows Fund Theft</a></ul><li><a href=https://4l0n3r.github.io/writeups/first-flight-3-thunder-loan/#medium>Medium</a> <ul><li><a href=https://4l0n3r.github.io/writeups/first-flight-3-thunder-loan/#m-1-vulnerability-in-tswap-price-oracle-allows-price-manipulation-attacks>[M-1] Vulnerability in TSwap Price Oracle Allows Price Manipulation Attacks</a></ul></ul></div><section class=body><h1 id=high><a aria-label="Anchor link for: high" class=zola-anchor href=#high>High</a></h1><h2 id=h-1-storage-collision-due-to-variable-order-mismatch><a aria-label="Anchor link for: h-1-storage-collision-due-to-variable-order-mismatch" class=zola-anchor href=#h-1-storage-collision-due-to-variable-order-mismatch>[H-1] Storage Collision Due to Variable Order Mismatch</a></h2><p><strong>Description:</strong> In the <code>ThunderLoan.sol</code> contract, the storage variables are declared in the following order:<pre class=language-solidity data-lang=solidity style=color:#61676c;background-color:#fafafa><code class=language-solidity data-lang=solidity><span>uint256 private s_feePrecision;  
</span><span>uint256 private s_flashLoanFee; // 0.3% ETH fee
</span></code></pre><p>However, in the upgraded <code>ThunderLoanUpgraded.sol</code> contract, the order is changed:<pre class=language-solidity data-lang=solidity style=color:#61676c;background-color:#fafafa><code class=language-solidity data-lang=solidity><span>uint256 private s_flashLoanFee; // 0.3% ETH fee  
</span><span>uint256 public constant FEE_PRECISION = 1e18;
</span></code></pre><p>Since Solidity relies on the order of variable declaration to assign storage slots, changing the order during an upgrade causes the <code>s_flashLoanFee</code> to incorrectly take on the value of <code>s_feePrecision</code>. Additionally, the <code>s_currentlyFlashLoaning</code> mapping will point to an incorrect storage location, leading to undefined behavior.<p><strong>Impact:</strong> After upgrading:<ul><li><strong>Incorrect Fees:</strong> The <code>s_flashLoanFee</code> will be set to the previous <code>s_feePrecision</code> value, leading to users being charged incorrect flash loan fees.<li><strong>Broken Mapping:</strong> The <code>s_currentlyFlashLoaning</code> mapping will be misaligned, potentially allowing users to bypass restrictions or causing faulty state tracking.</ul><p><strong>Proof of Code:</strong> The storage layout difference can be verified by running:<pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>forge</span><span> inspect ThunderLoan storage  
</span><span style=color:#f29718>forge</span><span> inspect ThunderLoanUpgraded storage
</span></code></pre><h2 id=h-2-incorrect-updateexchangerate-call-in-deposit-function><a aria-label="Anchor link for: h-2-incorrect-updateexchangerate-call-in-deposit-function" class=zola-anchor href=#h-2-incorrect-updateexchangerate-call-in-deposit-function>[H-2] Incorrect <code>updateExchangeRate</code> Call in <code>deposit</code> Function</a></h2><p><strong>Description:</strong><p>In the <code>deposit</code> function of the <code>ThunderLoan</code> contract, the <code>updateExchangeRate</code> function is unnecessarily called with <code>calculatedFee</code> immediately after minting.<pre class=language-solidity data-lang=solidity style=color:#61676c;background-color:#fafafa><code class=language-solidity data-lang=solidity><span>function deposit(IERC20 token, uint256 amount) external revertIfZero(amount) revertIfNotAllowedToken(token) {
</span><span>    AssetToken assetToken = s_tokenToAssetToken[token];
</span><span>    uint256 exchangeRate = assetToken.getExchangeRate();
</span><span>    uint256 mintAmount = (amount * assetToken.EXCHANGE_RATE_PRECISION()) / exchangeRate;
</span><span>
</span><span>    emit Deposit(msg.sender, token, amount);
</span><span>    assetToken.mint(msg.sender, mintAmount);
</span><span>
</span><span>    uint256 calculatedFee = getCalculatedFee(token, amount);
</span><span>    assetToken.updateExchangeRate(calculatedFee);
</span><span>
</span><span>    token.safeTransferFrom(msg.sender, address(assetToken), amount);
</span><span>}
</span></code></pre><p>The call to <code>updateExchangeRate</code> happens <strong>before</strong> the transferred amount is reflected in the asset balance. This leads to incorrect updates of the exchange rate.<p><strong>Impact:</strong><ul><li><strong>Incorrect Withdrawals:</strong> Users may be unable to withdraw correct amounts due to the miscalculated exchange rate.<li><strong>Unfair Reward Distribution:</strong> The updated exchange rate can cause unfair distribution of rewards, as the value is changed without accounting for the actual token balance.</ul><h2 id=h-3-flashloan-and-deposit-exploit-allows-fund-theft><a aria-label="Anchor link for: h-3-flashloan-and-deposit-exploit-allows-fund-theft" class=zola-anchor href=#h-3-flashloan-and-deposit-exploit-allows-fund-theft>[H-3] Flashloan and Deposit Exploit Allows Fund Theft</a></h2><p><strong>Description:</strong><br> A critical vulnerability exists where users can exploit the system by calling <code>ThunderLoan::deposit</code> instead of <code>ThunderLoan::repay</code> after taking a flashloan. This allows malicious users to bypass proper repayment and drain all funds from the protocol.<p><strong>Impact:</strong><ul><li>Malicious actors can steal all available funds from the protocol by manipulating the flashloan and deposit mechanism.<li>This could result in a complete loss of user deposits and system insolvency.</ul><p><strong>Recommended Mitigation:</strong><ul><li>Enforce strict checks to ensure that any outstanding flashloan must be repaid using <code>ThunderLoan::repay</code>.<li>Implement tracking to verify that all flashloaned funds are returned before allowing new deposits.</ul><hr><h1 id=medium><a aria-label="Anchor link for: medium" class=zola-anchor href=#medium>Medium</a></h1><h2 id=m-1-vulnerability-in-tswap-price-oracle-allows-price-manipulation-attacks><a aria-label="Anchor link for: m-1-vulnerability-in-tswap-price-oracle-allows-price-manipulation-attacks" class=zola-anchor href=#m-1-vulnerability-in-tswap-price-oracle-allows-price-manipulation-attacks>[M-1] Vulnerability in TSwap Price Oracle Allows Price Manipulation Attacks</a></h2><p><strong>Description:</strong><br> The ThunderLoan protocol relies on the TSwap AMM (Automated Market Maker) for price calculations. TSwap uses a constant product formula to determine token prices based on the pool's reserves. This mechanism is vulnerable to manipulation by users who perform large token swaps within a single transaction, bypassing protocol fees.<p><strong>Impact:</strong><br> Malicious users can manipulate token prices during a flash loan, leading to inaccurate pricing. This results in reduced fees for liquidity providers and potential financial loss for the protocol.<p><strong>Proof of Concept:</strong> Within a single transaction, a user can exploit the price calculation as follows:<ol><li>The user initiates a flash loan from ThunderLoan for 1000 tokenA, paying the standard fee (<code>fee1</code>).<li>During the flash loan, the user sells 1000 tokenA, significantly reducing its price in the TSwap pool.<li>Instead of repaying the flash loan immediately, the user takes a second flash loan for 1000 tokenA at a much lower price due to the manipulated price calculation:</ol><pre class=language-solidity data-lang=solidity style=color:#61676c;background-color:#fafafa><code class=language-solidity data-lang=solidity><span>function getPriceInWeth(address token) public view returns (uint256) {
</span><span>    address swapPoolOfToken = IPoolFactory(s_poolFactory).getPool(token);
</span><span>    return ITSwapPool(swapPoolOfToken).getPriceOfOnePoolTokenInWeth();
</span><span>}
</span></code></pre><ol start=4><li>The user repays the first flash loan and subsequently repays the second one at a lower cost.</ol><p>A proof of concept exists in the audit-data folder, demonstrating this exploit.<p><strong>Recommended Mitigation:</strong> To prevent price manipulation, replace the TSwap-based price calculation with a more robust oracle system. Consider using Chainlink price feeds as the primary oracle, with a Uniswap TWAP (Time-Weighted Average Price) fallback mechanism for enhanced security and accuracy.</section></article></main></div>